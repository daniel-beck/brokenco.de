--- 
layout: post
title: Facebook's Bleeding Edge
tags: 
- slide
- facebook
created: 1203304651
---
For the past couple weeks I've been living dangerously, as some people know I live in the <a href="http://en.wikipedia.org/wiki/Tenderloin,_San_Francisco,_California" target="_blank">Tenderloin District</a>, but that's not what I mean when I say "living dangerously." In my constant quest to squeeze as much performance out of <a href="http://apps.facebook.com/topeight/?home=1" target="_blank">Top Friends</a> as possible, I've been evaluating the latest and greatest stuff that Facebook has to offer developers. In addition to the usual adding of features, tuning virality, and general application upkeep, I've been exploring mixes of <A href="http://wiki.developers.facebook.com/index.php/FBML" target="_blank">FBML</a>, <a href="http://wiki.developers.facebook.com/index.php/FBJS" target="_blank">FBJS</a>, <a href="http://wiki.developers.facebook.com/index.php/Mock_ajax" target="_blank">Mock AJAX</a>, <a href="http://wiki.developers.facebook.com/index.php/Preload_FQL" target="_blank">preload FQL</a>, and <a href="http://wiki.developers.facebook.com/index.php/Using_batching_API" target="_blank">batched queries</a> all as a means to improve how fast Top Friends is for our users. I've been <a href="http://flickr.com/photos/agentdero/1130367017/in/set-72157601461292940/" target="_blank">saying for months</a> that it's exceptionally important to keep up with all of Facebook's changes, for better or for worse, and sometimes they throw out gems like preload FQL that will help shape new and interesting ways you can utilize Facebook's data inside your application.<br>
<br>
<big><strong>The Feature</strong></big><br>
The first obvious thing that I wanted to apply preload FQL to, was a new feature we've pushed out called "<a href="http://apps.facebook.com/topeight/?home=1" target="_blank">Top Friends News</a>" which aggregates "what's going on" with your Top Friends.<center><a href="http://tyler.geekisp.com/images/tfnews.png" rel="lightbox"><img src="http://tyler.geekisp.com/images/tfnews.png" width="500"/></a></center><br>
<!--break--><br>
It was very important to incorporate data from Facebook as well as our own data into the feature to make sure the page was as rich and interesting to the user as possible. Unfortunately, executing queries to fetch birthdays, recently uploaded photos, statuses, etc, are prohibitively expensive if you just run them as standard FQL queries. Even as preload FQL queries they are relatively expensive when hitting a cold cache. To ensure the page was as fast as possible using preload FQL we ran a <strong>lot</strong> of tests with various iterations of the queries and tuned everything as much as possible. I could yak endlessly on all the cool stuff we've done in this specific case to squeeze every last drop of performance out of the News page, but I'll cite the numbers and get to the nitty-gritty right away. <em>Before</em> we released the feature I tried the page with <strong>no</strong> preload FQL queries, and the necessary Facebook data was procured through painfully slow standard FQL queries. Executing these queries on the page made the "Top Friends News" page the <strong>slowest</strong> page <a href="http://www.slide.com" target="_blank">Slide</a> served up to Facebook, clocking in at about 2.5-3.0s. Simply unacceptable. After a long day of tuning and implementing all the queries to run as preloaded FQL queries, the "Top Friends News" page became the <strong>fastest</strong> page <a href="http://www.slide.com" target="_blank">Slide</a> serves up to Facebook at around 0.5s a pop.<br>
<br>
Although preload FQL is technically still a "beta feature" according to the <a href="http://wiki.developers.facebook.com/index.php/Category:Beta_Feature" target="_blank">wiki</a>, we've implemented it in an application that has millions of users daily; in my opinion preload FQL is "Google-beta" quality (which means, it's solid) as opposed to "Microsoft-beta" quality (which means, it sucks).<br>
<br>
<big><strong>Using preload FQL</strong></big><br>
If you grab the <a href="http://wiki.developers.facebook.com/index.php/PHP" target="_blank">latest PHP client library</a> from Facebook, support for preload FQL is already baked in via the <a href="http://wiki.developers.facebook.com/index.php/Admin.setAppProperties" target="_blank">admin.setAppProperties</a> API call. Actually calling the API call is relatively painless, it's something to do pre-push instead of "live" like normal FQL queries. Once you set your application's preload FQL rules, the results are simply posted to the FBML page matching the "pattern" you specified when you set the FQL rules to begin with (read the <a href="http://wiki.developers.facebook.com/index.php/Preload_FQL" target="_blank">wiki page for more</a>), when the results are POSTed however, they'll be formatted in JSON, similar to a regular FQL query if you specify ResponseType.JSON. This does mean however you should be using FBML for your application page to take advantage of preload FQL, it's possible to use iframe pages and preload FQL through a clever mix of memcached and &lt;fb:iframe/&gt;, but I won't go into that here.<br>
<br>
<big><strong>Performance Concerns</strong></big><br>
While moving to preload FQL means you lessen the chance that Facebook times out while trying to load your FBML page, if you structure your queries incorrectly you merely shuffle the lag-time for the user, you won't eliminate it. After working with some Facebook engineers on profiling the performance of preload FQL, they've added another parameter that will be posted into your FBML page that you can use to guage the time it took your preload FQL queries to execute. If you start logging <strong>fb_sig_time</strong> alongside <strong>fb_sig_preload_fql_timestamp</strong> you can measure the difference between when Facebook started to process your preload FQL rules (fb_sig_preload_fql_timestamp), and when Facebook called your server for the page (fb_sig_time).<br>
<br>
Mixing and matching FBJS, FBML and preload FQL rules in your pages can allow you to create blistering-fast pages that are as rich as possible for your users, while allowing you do to more with less (server-wise) than you could ever do before. Add in a bit of the <a href="http://wiki.developers.facebook.com/index.php/Data_Store_API_documentation" target="_blank">Data Store API</a> and you'll have pages that rival Facebook's own in terms of speed at prices that rival Amazon's S3 in terms of overall cost. In general Facebook is an engineering organization with <strong>lots</strong> of smart people working for them, and most of those smart people (that I've met anyways) are working to make the Facebook Platform even better than it is now, meaning the time you put into exploring new parts of the platform will most definitely have been worth it after you start to use some of Facebook's more "bleeding edge" features that are designed to make your life easier, not harder.<br>
<br>
2008 is going to be an interesting year.
